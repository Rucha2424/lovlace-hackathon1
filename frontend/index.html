<!doctype html>
<html lang="en">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nokia Fronthaul Visualizer</title><!-- Vis Network -->
  <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script><!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script><!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&amp;family=Rajdhani:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: linear-gradient(135deg, #0a0a1a 0%, #1a1a3e 50%, #0d0d2b 100%);
      color: #eaeaea;
      font-family: 'Rajdhani', sans-serif;
      min-height: 100%;
      overflow-x: hidden;
      position: relative;
    }

    /* Animated background grid */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: 
        linear-gradient(rgba(0, 212, 255, 0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0, 212, 255, 0.03) 1px, transparent 1px);
      background-size: 50px 50px;
      animation: gridMove 20s linear infinite;
      pointer-events: none;
      z-index: 0;
    }

    @keyframes gridMove {
      0% { transform: translate(0, 0); }
      100% { transform: translate(50px, 50px); }
    }

    /* Floating particles */
    .particle {
      position: fixed;
      width: 4px;
      height: 4px;
      background: rgba(0, 212, 255, 0.6);
      border-radius: 50%;
      pointer-events: none;
      z-index: 1;
      animation: float 15s infinite ease-in-out;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0) translateX(0); opacity: 0; }
      10% { opacity: 1; }
      90% { opacity: 1; }
      50% { transform: translateY(-100px) translateX(50px); }
    }

    .app-container {
      position: relative;
      z-index: 10;
      padding: 30px;
      max-width: 1600px;
      margin: 0 auto;
    }

    /* Header Section */
    .header {
      text-align: center;
      margin-bottom: 40px;
      position: relative;
    }

    .nokia-badge {
      display: inline-flex;
      align-items: center;
      gap: 15px;
      background: linear-gradient(135deg, rgba(0, 45, 98, 0.8), rgba(0, 30, 60, 0.9));
      padding: 15px 30px;
      border-radius: 50px;
      border: 2px solid rgba(0, 212, 255, 0.3);
      margin-bottom: 20px;
      box-shadow: 
        0 10px 40px rgba(0, 212, 255, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
      transform: perspective(500px) rotateX(5deg);
      transition: all 0.3s ease;
    }

    .nokia-badge:hover {
      transform: perspective(500px) rotateX(0deg) scale(1.02);
      box-shadow: 
        0 15px 50px rgba(0, 212, 255, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.15);
    }

    .nokia-logo {
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, #00d4ff, #0099cc);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Orbitron', sans-serif;
      font-weight: 900;
      font-size: 18px;
      color: #001a33;
      box-shadow: 0 4px 15px rgba(0, 212, 255, 0.4);
    }

    .nokia-text {
      font-family: 'Orbitron', sans-serif;
      font-size: 24px;
      font-weight: 700;
      background: linear-gradient(90deg, #00d4ff, #00ffcc);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      letter-spacing: 3px;
    }

    h1 {
      font-family: 'Orbitron', sans-serif;
      font-size: 42px;
      font-weight: 900;
      background: linear-gradient(135deg, #ffffff 0%, #00d4ff 50%, #00ffcc 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-transform: uppercase;
      letter-spacing: 4px;
      margin-bottom: 10px;
      text-shadow: 0 0 40px rgba(0, 212, 255, 0.5);
      animation: titleGlow 3s ease-in-out infinite alternate;
    }

    @keyframes titleGlow {
      0% { filter: drop-shadow(0 0 20px rgba(0, 212, 255, 0.3)); }
      100% { filter: drop-shadow(0 0 40px rgba(0, 255, 204, 0.5)); }
    }

    .subtitle {
      font-size: 18px;
      color: rgba(255, 255, 255, 0.6);
      letter-spacing: 8px;
      text-transform: uppercase;
      font-weight: 300;
    }

    /* Status Bar */
    .status-bar {
      display: flex;
      justify-content: center;
      gap: 40px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }

    .status-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 25px;
      background: rgba(0, 20, 40, 0.6);
      border-radius: 30px;
      border: 1px solid rgba(0, 212, 255, 0.2);
      transition: all 0.3s ease;
    }

    .status-item:hover {
      border-color: rgba(0, 212, 255, 0.5);
      transform: translateY(-2px);
    }

    .status-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    .status-dot.online { background: #22c55e; box-shadow: 0 0 15px #22c55e; }
    .status-dot.processing { background: #facc15; box-shadow: 0 0 15px #facc15; }
    .status-dot.network { background: #00d4ff; box-shadow: 0 0 15px #00d4ff; }

    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.2); opacity: 0.7; }
    }

    .status-label {
      font-size: 14px;
      color: rgba(255, 255, 255, 0.8);
      font-weight: 500;
    }

    /* Control Panel */
    .control-panel {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 40px;
      flex-wrap: wrap;
    }

    .btn-3d {
      position: relative;
      padding: 18px 45px;
      font-family: 'Orbitron', sans-serif;
      font-size: 16px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 3px;
      border: none;
      border-radius: 15px;
      cursor: pointer;
      overflow: hidden;
      transition: all 0.3s ease;
      transform: perspective(500px) rotateX(10deg);
      box-shadow: 
        0 15px 35px rgba(0, 0, 0, 0.3),
        0 5px 15px rgba(0, 0, 0, 0.2);
    }

    .btn-primary {
      background: linear-gradient(135deg, #00d4ff 0%, #0099cc 50%, #006699 100%);
      color: #001a33;
    }

    .btn-primary::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
      transition: left 0.5s ease;
    }

    .btn-primary:hover::before {
      left: 100%;
    }

    .btn-primary:hover {
      transform: perspective(500px) rotateX(0deg) translateY(-5px);
      box-shadow: 
        0 25px 50px rgba(0, 212, 255, 0.4),
        0 10px 25px rgba(0, 0, 0, 0.3);
    }

    .btn-primary:active {
      transform: perspective(500px) rotateX(15deg) translateY(0);
    }

    .btn-secondary {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
      color: #00d4ff;
      border: 2px solid rgba(0, 212, 255, 0.3);
    }

    .btn-secondary:hover {
      background: linear-gradient(135deg, rgba(0, 212, 255, 0.2), rgba(0, 212, 255, 0.1));
      border-color: #00d4ff;
      transform: perspective(500px) rotateX(0deg) translateY(-5px);
    }

    .btn-icon {
      margin-right: 10px;
      font-size: 20px;
    }

    /* Network Visualization Container */
    .visualization-section {
      margin-bottom: 50px;
    }

    .section-header {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 20px;
    }

    .section-icon {
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, #00d4ff, #0099cc);
      border-radius: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      box-shadow: 0 8px 25px rgba(0, 212, 255, 0.3);
      transform: rotate(-5deg);
      transition: all 0.3s ease;
    }

    .section-header:hover .section-icon {
      transform: rotate(0deg) scale(1.1);
    }

    .section-title {
      font-family: 'Orbitron', sans-serif;
      font-size: 24px;
      font-weight: 700;
      color: #ffffff;
      letter-spacing: 2px;
    }

    .section-subtitle {
      font-size: 14px;
      color: rgba(255, 255, 255, 0.5);
      letter-spacing: 1px;
    }

    .network-container {
      position: relative;
      background: linear-gradient(180deg, rgba(0, 20, 40, 0.8), rgba(0, 10, 25, 0.9));
      border-radius: 25px;
      border: 2px solid rgba(0, 212, 255, 0.2);
      overflow: hidden;
      box-shadow: 
        0 25px 80px rgba(0, 0, 0, 0.5),
        inset 0 1px 0 rgba(255, 255, 255, 0.05),
        0 0 100px rgba(0, 212, 255, 0.1);
      transform: perspective(1000px) rotateX(2deg);
      transition: all 0.5s ease;
    }

    .network-container:hover {
      transform: perspective(1000px) rotateX(0deg);
      border-color: rgba(0, 212, 255, 0.4);
      box-shadow: 
        0 30px 100px rgba(0, 0, 0, 0.6),
        inset 0 1px 0 rgba(255, 255, 255, 0.08),
        0 0 150px rgba(0, 212, 255, 0.15);
    }

    .network-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        radial-gradient(ellipse at 30% 20%, rgba(0, 212, 255, 0.1) 0%, transparent 50%),
        radial-gradient(ellipse at 70% 80%, rgba(0, 255, 204, 0.08) 0%, transparent 50%);
      pointer-events: none;
      z-index: 1;
    }

    .corner-accent {
      position: absolute;
      width: 80px;
      height: 80px;
      border: 3px solid rgba(0, 212, 255, 0.3);
      z-index: 2;
      pointer-events: none;
    }

    .corner-accent.top-left {
      top: 15px;
      left: 15px;
      border-right: none;
      border-bottom: none;
      border-radius: 15px 0 0 0;
    }

    .corner-accent.top-right {
      top: 15px;
      right: 15px;
      border-left: none;
      border-bottom: none;
      border-radius: 0 15px 0 0;
    }

    .corner-accent.bottom-left {
      bottom: 15px;
      left: 15px;
      border-right: none;
      border-top: none;
      border-radius: 0 0 0 15px;
    }

    .corner-accent.bottom-right {
      bottom: 15px;
      right: 15px;
      border-left: none;
      border-top: none;
      border-radius: 0 0 15px 0;
    }

    #network {
      width: 100%;
      height: 500px;
      background: transparent;
      position: relative;
      z-index: 0;
    }

    .network-legend {
      position: absolute;
      bottom: 20px;
      left: 20px;
      display: flex;
      gap: 20px;
      padding: 15px 25px;
      background: rgba(0, 10, 25, 0.9);
      border-radius: 15px;
      border: 1px solid rgba(0, 212, 255, 0.2);
      z-index: 10;
      backdrop-filter: blur(10px);
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: rgba(255, 255, 255, 0.8);
    }

    .legend-color {
      width: 20px;
      height: 4px;
      border-radius: 2px;
    }

    /* Charts Section */
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
      gap: 30px;
    }

    .chart-card {
      background: linear-gradient(180deg, rgba(0, 20, 40, 0.8), rgba(0, 10, 25, 0.9));
      border-radius: 25px;
      border: 2px solid rgba(0, 212, 255, 0.15);
      padding: 30px;
      position: relative;
      overflow: hidden;
      box-shadow: 
        0 20px 60px rgba(0, 0, 0, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.05);
      transform: perspective(800px) rotateY(-2deg);
      transition: all 0.5s ease;
    }

    .chart-card:nth-child(even) {
      transform: perspective(800px) rotateY(2deg);
    }

    .chart-card:hover {
      transform: perspective(800px) rotateY(0deg) translateY(-10px);
      border-color: rgba(0, 212, 255, 0.3);
      box-shadow: 
        0 30px 80px rgba(0, 0, 0, 0.5),
        0 0 60px rgba(0, 212, 255, 0.1);
    }

    .chart-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, transparent, #00d4ff, #00ffcc, transparent);
    }

    .chart-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 25px;
    }

    .chart-title {
      font-family: 'Orbitron', sans-serif;
      font-size: 18px;
      font-weight: 600;
      color: #ffffff;
      letter-spacing: 1px;
    }

    .chart-badge {
      padding: 6px 15px;
      background: rgba(0, 212, 255, 0.15);
      border: 1px solid rgba(0, 212, 255, 0.3);
      border-radius: 20px;
      font-size: 12px;
      color: #00d4ff;
      font-weight: 600;
      letter-spacing: 1px;
    }

    .chart-wrapper {
      position: relative;
      height: 300px;
    }

    /* Metrics Panel */
    .metrics-panel {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 40px;
    }

    .metric-card {
      background: linear-gradient(135deg, rgba(0, 20, 40, 0.7), rgba(0, 10, 25, 0.8));
      border-radius: 20px;
      border: 1px solid rgba(0, 212, 255, 0.15);
      padding: 25px;
      text-align: center;
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
      transform: perspective(500px) rotateX(5deg);
    }

    .metric-card:hover {
      transform: perspective(500px) rotateX(0deg) scale(1.05);
      border-color: rgba(0, 212, 255, 0.4);
      box-shadow: 0 15px 40px rgba(0, 212, 255, 0.2);
    }

    .metric-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, transparent, var(--accent-color, #00d4ff), transparent);
    }

    .metric-icon {
      font-size: 32px;
      margin-bottom: 15px;
      display: block;
    }

    .metric-value {
      font-family: 'Orbitron', sans-serif;
      font-size: 32px;
      font-weight: 900;
      background: linear-gradient(135deg, #ffffff, var(--accent-color, #00d4ff));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 8px;
    }

    .metric-label {
      font-size: 14px;
      color: rgba(255, 255, 255, 0.6);
      text-transform: uppercase;
      letter-spacing: 2px;
    }

    /* Loading State */
    .loading-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      gap: 20px;
    }

    .loading-overlay.active {
      display: flex;
    }

    .loading-spinner {
      width: 80px;
      height: 80px;
      border: 4px solid rgba(0, 212, 255, 0.1);
      border-top-color: #00d4ff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-text {
      font-family: 'Orbitron', sans-serif;
      font-size: 16px;
      color: #00d4ff;
      letter-spacing: 3px;
      animation: loadingPulse 1.5s ease-in-out infinite;
    }

    @keyframes loadingPulse {
      0%, 100% { opacity: 0.5; }
      50% { opacity: 1; }
    }

    /* Footer */
    .footer {
      text-align: center;
      margin-top: 50px;
      padding: 30px;
      border-top: 1px solid rgba(0, 212, 255, 0.1);
    }

    .footer-text {
      font-size: 14px;
      color: rgba(255, 255, 255, 0.4);
      letter-spacing: 2px;
    }

    /* Responsive */
    @media (max-width: 768px) {
      h1 {
        font-size: 24px;
        letter-spacing: 2px;
      }
      
      .charts-grid {
        grid-template-columns: 1fr;
      }
      
      .nokia-badge {
        padding: 10px 20px;
      }
      
      .nokia-text {
        font-size: 18px;
      }
      
      .btn-3d {
        padding: 14px 30px;
        font-size: 14px;
      }
      
      #network {
        height: 350px;
      }
      
      .network-legend {
        flex-wrap: wrap;
        gap: 10px;
      }
    }

    /* Error Toast */
    .toast {
      position: fixed;
      bottom: 30px;
      right: 30px;
      padding: 20px 30px;
      background: linear-gradient(135deg, #ff4444, #cc0000);
      border-radius: 15px;
      color: white;
      font-weight: 600;
      z-index: 1000;
      transform: translateX(400px);
      transition: transform 0.5s ease;
      box-shadow: 0 10px 40px rgba(255, 0, 0, 0.3);
    }

    .toast.show {
      transform: translateX(0);
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body><!-- Floating Particles -->
  <div class="particle" style="top: 10%; left: 20%; animation-delay: 0s;"></div>
  <div class="particle" style="top: 30%; left: 80%; animation-delay: 2s;"></div>
  <div class="particle" style="top: 60%; left: 10%; animation-delay: 4s;"></div>
  <div class="particle" style="top: 80%; left: 70%; animation-delay: 6s;"></div>
  <div class="particle" style="top: 40%; left: 50%; animation-delay: 8s;"></div>
  <div class="particle" style="top: 20%; left: 60%; animation-delay: 10s;"></div><!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
   <div class="loading-spinner"></div>
   <div class="loading-text">
    ANALYZING NETWORK...
   </div>
  </div><!-- Toast Notification -->
  <div class="toast" id="errorToast">
   ‚ö†Ô∏è Connection failed. Please check backend server.
  </div>
  <div class="app-container"><!-- Header -->
   <header class="header">
    <div class="nokia-badge">
     <div class="nokia-logo">
      N
     </div><span class="nokia-text">NOKIA</span>
    </div>
    <h1>Fronthaul Network Optimizer</h1>
    <p class="subtitle">Advanced 5G Network Analysis Platform</p>
   </header><!-- Status Bar -->
   <div class="status-bar">
    <div class="status-item">
     <div class="status-dot online"></div><span class="status-label">System Online</span>
    </div>
    <div class="status-item">
     <div class="status-dot processing"></div><span class="status-label">Ready to Analyze</span>
    </div>
    <div class="status-item">
     <div class="status-dot network"></div><span class="status-label">Network Connected</span>
    </div>
   </div><!-- Control Panel -->
   <div class="control-panel"><button class="btn-3d btn-primary" id="runBtn"> <span class="btn-icon">‚ö°</span> Run Analysis </button> <button class="btn-3d btn-secondary" id="refreshBtn"> <span class="btn-icon">üîÑ</span> Refresh View </button>
   </div><!-- Network Visualization -->
   <section class="visualization-section">
    <div class="section-header">
     <div class="section-icon">
      üåê
     </div>
     <div>
      <h2 class="section-title">Network Topology</h2>
      <p class="section-subtitle">Real-time cell site connections</p>
     </div>
    </div>
    <div class="network-container">
     <div class="network-overlay"></div>
     <div class="corner-accent top-left"></div>
     <div class="corner-accent top-right"></div>
     <div class="corner-accent bottom-left"></div>
     <div class="corner-accent bottom-right"></div>
     <div id="network"></div>
     <div class="network-legend">
      <div class="legend-item">
       <div class="legend-color" style="background: #f72585;"></div><span>Group 1</span>
      </div>
      <div class="legend-item">
       <div class="legend-color" style="background: #22c55e;"></div><span>Group 2</span>
      </div>
      <div class="legend-item">
       <div class="legend-color" style="background: #4cc9f0;"></div><span>Group 3</span>
      </div>
      <div class="legend-item">
       <div class="legend-color" style="background: #facc15;"></div><span>Group 4</span>
      </div>
      <div class="legend-item">
       <div class="legend-color" style="background: #a855f7;"></div><span>Group 5</span>
      </div>
     </div>
    </div>
   </section><!-- Charts Section -->
   <section class="visualization-section">
    <div class="section-header">
     <div class="section-icon">
      üìä
     </div>
     <div>
      <h2 class="section-title">Capacity Analysis</h2>
      <p class="section-subtitle">Link performance metrics</p>
     </div>
    </div>
    <div class="charts-grid">
     <div class="chart-card">
      <div class="chart-card-header">
       <h3 class="chart-title">Link Capacity Comparison</h3><span class="chart-badge">GBPS</span>
      </div>
      <div class="chart-wrapper">
       <canvas id="capacityChart"></canvas>
      </div>
     </div>
     <div class="chart-card">
      <div class="chart-card-header">
       <h3 class="chart-title">Buffer Efficiency</h3><span class="chart-badge">%</span>
      </div>
      <div class="chart-wrapper">
       <canvas id="efficiencyChart"></canvas>
      </div>
     </div>
    </div>
   </section><!-- Metrics Panel -->
   <div class="metrics-panel">
    <div class="metric-card" style="--accent-color: #00d4ff;"><span class="metric-icon">üîó</span>
     <div class="metric-value" id="totalLinks">
      --
     </div>
     <div class="metric-label">
      Total Links
     </div>
    </div>
    <div class="metric-card" style="--accent-color: #22c55e;"><span class="metric-icon">üìà</span>
     <div class="metric-value" id="avgCapacity">
      --
     </div>
     <div class="metric-label">
      Avg Capacity
     </div>
    </div>
    <div class="metric-card" style="--accent-color: #f72585;"><span class="metric-icon">‚ö°</span>
     <div class="metric-value" id="maxCapacity">
      --
     </div>
     <div class="metric-label">
      Max Capacity
     </div>
    </div>
    <div class="metric-card" style="--accent-color: #facc15;"><span class="metric-icon">üéØ</span>
     <div class="metric-value" id="efficiency">
      --
     </div>
     <div class="metric-label">
      Avg Efficiency
     </div>
    </div>
   </div><!-- Footer -->
   <footer class="footer">
    <p class="footer-text">NOKIA FRONTHAUL OPTIMIZER ¬© 2024 | ADVANCED NETWORK ANALYTICS</p>
   </footer>
  </div>
  <script>
let network = null;
let capacityChart = null;
let efficiencyChart = null;

/* ---------- BUTTONS ---------- */
document.getElementById("runBtn").addEventListener("click", run);
document.getElementById("refreshBtn").addEventListener("click", () => {
  if (network) network.fit();
});

/* ---------- TOAST HELPER ---------- */
function showToast(message) {
  const toast = document.getElementById("errorToast");
  toast.textContent = "‚ö†Ô∏è " + message;
  toast.classList.add("show");
  setTimeout(() => toast.classList.remove("show"), 4000);
}

/* ---------- LOADING STATE ---------- */
function setLoading(loading) {
  const overlay = document.getElementById("loadingOverlay");
  if (loading) {
    overlay.classList.add("active");
  } else {
    overlay.classList.remove("active");
  }
}

/* ---------- MAIN ---------- */
function run() {
  setLoading(true);
  
  fetch("http://localhost:8000/analyze")
    .then(r => r.json())
    .then(data => {
      setLoading(false);
      drawNetwork(data.topology);
      drawCapacityChart(data.capacity);
      drawEfficiencyChart(data.capacity);
      updateMetrics(data.capacity);
    })
    .catch(err => {
      setLoading(false);
      showToast("Fetch failed. Check backend server.");
      console.error(err);
    });
}

/* ---------- TOPOLOGY ---------- */
function drawNetwork(topology) {
  const nodes = [];
  const edges = [];
  const colors = ["#f72585", "#22c55e", "#4cc9f0", "#facc15", "#a855f7"];

  topology.flat().forEach(cell => {
    if (!nodes.find(n => n.id === cell)) {
      nodes.push({ 
        id: cell, 
        label: cell, 
        color: {
          background: '#001a33',
          border: '#00d4ff',
          highlight: {
            background: '#003366',
            border: '#00ffcc'
          }
        },
        borderWidth: 3,
        font: {
          color: '#ffffff',
          size: 14,
          face: 'Rajdhani',
          bold: true
        },
        shadow: {
          enabled: true,
          color: 'rgba(0, 212, 255, 0.5)',
          size: 15,
          x: 0,
          y: 0
        },
        shape: 'box',
        shapeProperties: {
          borderRadius: 8
        }
      });
    }
  });

  topology.forEach((group, idx) => {
    if (group.length >= 2) {
      for (let i = 1; i < group.length; i++) {
        edges.push({
          from: group[0],
          to: group[i],
          color: {
            color: colors[idx % colors.length],
            highlight: '#00ffcc'
          },
          width: 4,
          smooth: {
            enabled: true,
            type: 'continuous',
            roundness: 0.5
          },
          shadow: {
            enabled: true,
            color: colors[idx % colors.length],
            size: 10,
            x: 0,
            y: 0
          }
        });
      }
    }
  });

  const container = document.getElementById("network");

  if (network) {
    network.destroy();
  }

  network = new vis.Network(
    container,
    { nodes: new vis.DataSet(nodes), edges: new vis.DataSet(edges) },
    { 
      physics: { 
        stabilization: false,
        barnesHut: {
          gravitationalConstant: -3000,
          springConstant: 0.04,
          springLength: 150
        }
      },
      interaction: {
        hover: true,
        tooltipDelay: 200,
        zoomView: true,
        dragView: true
      },
      nodes: {
        scaling: {
          min: 10,
          max: 30
        }
      }
    }
  );
}

/* ---------- CAPACITY CHART ---------- */
function drawCapacityChart(capacity) {
  const labels = [];
  const noBuffer = [];
  const withBuffer = [];

  Object.keys(capacity).forEach(link => {
    labels.push(link);
    noBuffer.push(capacity[link].capacity_no_buffer_Gbps);
    withBuffer.push(capacity[link].capacity_with_buffer_Gbps);
  });

  const ctx = document.getElementById("capacityChart").getContext("2d");

  if (capacityChart) {
    capacityChart.destroy();
  }

  capacityChart = new Chart(ctx, {
    type: "bar",
    data: {
      labels: labels,
      datasets: [
        {
          label: "Without Buffer",
          data: noBuffer,
          backgroundColor: "rgba(239, 68, 68, 0.8)",
          borderColor: "#ef4444",
          borderWidth: 2,
          borderRadius: 8,
          borderSkipped: false
        },
        {
          label: "With Buffer",
          data: withBuffer,
          backgroundColor: "rgba(34, 197, 94, 0.8)",
          borderColor: "#22c55e",
          borderWidth: 2,
          borderRadius: 8,
          borderSkipped: false
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { 
          labels: { 
            color: "rgba(255, 255, 255, 0.8)",
            font: {
              family: 'Rajdhani',
              size: 13,
              weight: '600'
            },
            padding: 20
          }
        },
        tooltip: {
          backgroundColor: 'rgba(0, 20, 40, 0.95)',
          titleColor: '#00d4ff',
          bodyColor: '#ffffff',
          borderColor: 'rgba(0, 212, 255, 0.3)',
          borderWidth: 1,
          padding: 15,
          cornerRadius: 10,
          titleFont: {
            family: 'Orbitron',
            size: 14,
            weight: '700'
          },
          bodyFont: {
            family: 'Rajdhani',
            size: 13
          }
        }
      },
      scales: {
        x: { 
          ticks: { 
            color: "rgba(255, 255, 255, 0.7)",
            font: {
              family: 'Rajdhani',
              size: 12
            }
          },
          grid: {
            color: 'rgba(0, 212, 255, 0.1)'
          }
        },
        y: {
          ticks: { 
            color: "rgba(255, 255, 255, 0.7)",
            font: {
              family: 'Rajdhani',
              size: 12
            }
          },
          title: {
            display: true,
            text: "Gbps",
            color: "#00d4ff",
            font: {
              family: 'Orbitron',
              size: 14,
              weight: '600'
            }
          },
          grid: {
            color: 'rgba(0, 212, 255, 0.1)'
          }
        }
      },
      animation: {
        duration: 1500,
        easing: 'easeOutQuart'
      }
    }
  });
}

/* ---------- EFFICIENCY CHART ---------- */
function drawEfficiencyChart(capacity) {
  const labels = [];
  const efficiencyData = [];

  Object.keys(capacity).forEach(link => {
    labels.push(link);
    const noBuffer = capacity[link].capacity_no_buffer_Gbps;
    const withBuffer = capacity[link].capacity_with_buffer_Gbps;
    const efficiency = noBuffer > 0 ? ((withBuffer - noBuffer) / noBuffer * 100).toFixed(1) : 0;
    efficiencyData.push(efficiency);
  });

  const ctx = document.getElementById("efficiencyChart").getContext("2d");

  if (efficiencyChart) {
    efficiencyChart.destroy();
  }

  efficiencyChart = new Chart(ctx, {
    type: "line",
    data: {
      labels: labels,
      datasets: [
        {
          label: "Buffer Improvement",
          data: efficiencyData,
          backgroundColor: "rgba(0, 212, 255, 0.2)",
          borderColor: "#00d4ff",
          borderWidth: 3,
          fill: true,
          tension: 0.4,
          pointBackgroundColor: "#00d4ff",
          pointBorderColor: "#ffffff",
          pointBorderWidth: 2,
          pointRadius: 6,
          pointHoverRadius: 10,
          pointHoverBackgroundColor: "#00ffcc"
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { 
          labels: { 
            color: "rgba(255, 255, 255, 0.8)",
            font: {
              family: 'Rajdhani',
              size: 13,
              weight: '600'
            }
          }
        },
        tooltip: {
          backgroundColor: 'rgba(0, 20, 40, 0.95)',
          titleColor: '#00d4ff',
          bodyColor: '#ffffff',
          borderColor: 'rgba(0, 212, 255, 0.3)',
          borderWidth: 1,
          padding: 15,
          cornerRadius: 10,
          callbacks: {
            label: function(context) {
              return `Improvement: ${context.raw}%`;
            }
          }
        }
      },
      scales: {
        x: { 
          ticks: { 
            color: "rgba(255, 255, 255, 0.7)",
            font: {
              family: 'Rajdhani',
              size: 12
            }
          },
          grid: {
            color: 'rgba(0, 212, 255, 0.1)'
          }
        },
        y: {
          ticks: { 
            color: "rgba(255, 255, 255, 0.7)",
            font: {
              family: 'Rajdhani',
              size: 12
            },
            callback: function(value) {
              return value + '%';
            }
          },
          title: {
            display: true,
            text: "Improvement %",
            color: "#00d4ff",
            font: {
              family: 'Orbitron',
              size: 14,
              weight: '600'
            }
          },
          grid: {
            color: 'rgba(0, 212, 255, 0.1)'
          }
        }
      },
      animation: {
        duration: 2000,
        easing: 'easeOutQuart'
      }
    }
  });
}

/* ---------- UPDATE METRICS ---------- */
function updateMetrics(capacity) {
  const links = Object.keys(capacity);
  const totalLinks = links.length;
  
  let totalWithBuffer = 0;
  let maxWithBuffer = 0;
  let totalEfficiency = 0;
  
  links.forEach(link => {
    const withBuffer = capacity[link].capacity_with_buffer_Gbps;
    const noBuffer = capacity[link].capacity_no_buffer_Gbps;
    
    totalWithBuffer += withBuffer;
    if (withBuffer > maxWithBuffer) maxWithBuffer = withBuffer;
    
    if (noBuffer > 0) {
      totalEfficiency += ((withBuffer - noBuffer) / noBuffer * 100);
    }
  });
  
  const avgCapacity = totalLinks > 0 ? (totalWithBuffer / totalLinks).toFixed(1) : 0;
  const avgEfficiency = totalLinks > 0 ? (totalEfficiency / totalLinks).toFixed(1) : 0;
  
  // Animate metrics
  animateValue('totalLinks', 0, totalLinks, 1000, '');
  animateValue('avgCapacity', 0, parseFloat(avgCapacity), 1000, ' Gbps');
  animateValue('maxCapacity', 0, parseFloat(maxWithBuffer.toFixed(1)), 1000, ' Gbps');
  animateValue('efficiency', 0, parseFloat(avgEfficiency), 1000, '%');
}

function animateValue(elementId, start, end, duration, suffix) {
  const element = document.getElementById(elementId);
  const range = end - start;
  const startTime = performance.now();
  
  function update(currentTime) {
    const elapsed = currentTime - startTime;
    const progress = Math.min(elapsed / duration, 1);
    const easeProgress = 1 - Math.pow(1 - progress, 3); // Ease out cubic
    const current = start + range * easeProgress;
    
    if (Number.isInteger(end)) {
      element.textContent = Math.round(current) + suffix;
    } else {
      element.textContent = current.toFixed(1) + suffix;
    }
    
    if (progress < 1) {
      requestAnimationFrame(update);
    }
  }
  
  requestAnimationFrame(update);
}
</script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9c6c49c931227e9d',t:'MTc2OTg5NDc5Ni4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>